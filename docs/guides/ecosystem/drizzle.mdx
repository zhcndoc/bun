---
title: 在 Bun 中使用 Drizzle ORM
sidebarTitle: Drizzle 与 Bun
mode: center
---

Drizzle 是一个支持类 SQL “查询构建器”API 和类 ORM [查询 API](https://orm.drizzle.team/docs/rqb) 的 ORM。它支持内置模块 `bun:sqlite`。

---

让我们通过 `bun init` 创建一个全新的项目并安装 Drizzle。

```sh terminal icon="terminal"
bun init -y
bun add drizzle-orm
bun add -D drizzle-kit
```

---

然后我们将使用 `bun:sqlite` 模块连接到 SQLite 数据库，并创建 Drizzle 数据库实例。

```ts db.ts icon="/icons/typescript.svg"
import { drizzle } from "drizzle-orm/bun-sqlite";
import { Database } from "bun:sqlite";

const sqlite = new Database("sqlite.db");
export const db = drizzle(sqlite);
```

---

为了查看数据库的实际效果，向 `index.ts` 添加以下代码。

```ts index.ts icon="/icons/typescript.svg"
import { db } from "./db";
import { sql } from "drizzle-orm";

const query = sql`select "hello world" as text`;
const result = db.get<{ text: string }>(query);
console.log(result);
```

---

然后使用 Bun 运行 `index.ts`。Bun 会自动创建 `sqlite.db` 并执行查询。

```sh terminal icon="terminal"
bun run index.ts
```

```txt
{
  text: "hello world"
}
```

---

让我们为数据库定义一个合适的模式。创建一个 `schema.ts` 文件并定义一个 `movies` 表。

```ts schema.ts icon="/icons/typescript.svg"
import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";

export const movies = sqliteTable("movies", {
  id: integer("id").primaryKey(),
  title: text("name"),
  releaseYear: integer("release_year"),
});
```

---

我们可以使用 `drizzle-kit` CLI 来生成初始的 SQL 迁移。

```sh terminal icon="terminal"
bunx drizzle-kit generate --dialect sqlite --schema ./schema.ts
```

---

这会创建一个新的 `drizzle` 目录，其中包含 `.sql` 迁移文件和 `meta` 目录。

```txt File Tree icon="folder-tree"
drizzle
├── 0000_ordinary_beyonder.sql
└── meta
    ├── 0000_snapshot.json
    └── _journal.json
```

---

我们可以通过一个简单的 `migrate.ts` 脚本执行这些迁移。

该脚本创建了一个指向 `sqlite.db` 的 SQLite 新连接，然后执行 `drizzle` 目录中所有未执行的迁移。

```ts migrate.ts icon="/icons/typescript.svg"
import { migrate } from "drizzle-orm/bun-sqlite/migrator";

import { drizzle } from "drizzle-orm/bun-sqlite";
import { Database } from "bun:sqlite";

const sqlite = new Database("sqlite.db");
const db = drizzle(sqlite);
migrate(db, { migrationsFolder: "./drizzle" });
```

---

我们可以使用 `bun` 运行这个脚本来执行迁移。

```sh terminal icon="terminal"
bun run migrate.ts
```

---

现在我们有了数据库，让我们添加一些数据。创建一个 `seed.ts` 文件，内容如下。

```ts seed.ts icon="/icons/typescript.svg"
import { db } from "./db";
import * as schema from "./schema";

await db.insert(schema.movies).values([
  {
    title: "The Matrix",
    releaseYear: 1999,
  },
  {
    title: "The Matrix Reloaded",
    releaseYear: 2003,
  },
  {
    title: "The Matrix Revolutions",
    releaseYear: 2003,
  },
]);

console.log(`Seeding complete.`);
```

---

然后运行该文件。

```sh terminal icon="terminal"
bun run seed.ts
```

```txt
Seeding complete.
```

---

我们终于有了带模式和示例数据的数据库。让我们使用 Drizzle 查询它。用以下内容替换 `index.ts`。

```ts index.ts icon="/icons/typescript.svg"
import * as schema from "./schema";
import { db } from "./db";

const result = await db.select().from(schema.movies);
console.log(result);
```

---

然后运行该文件。你应该能看到我们插入的三部电影。

```sh terminal icon="terminal"
bun run index.ts
```

```txt
[
  {
    id: 1,
    title: "The Matrix",
    releaseYear: 1999
  }, {
    id: 2,
    title: "The Matrix Reloaded",
    releaseYear: 2003
  }, {
    id: 3,
    title: "The Matrix Revolutions",
    releaseYear: 2003
  }
]
```

---

完整文档请参考 [Drizzle 官网](https://orm.drizzle.team/docs/overview)。
