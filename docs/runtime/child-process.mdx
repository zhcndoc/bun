---
title: Spawnï¼ˆåˆ›å»ºå­è¿›ç¨‹ï¼‰
description: ä½¿ç”¨ `Bun.spawn` æˆ– `Bun.spawnSync` åˆ›å»ºå­è¿›ç¨‹
---

## åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ (`Bun.spawn()`)

æä¾›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ä½œä¸ºå‘½ä»¤ã€‚`Bun.spawn()` è¿”å›ä¸€ä¸ª `Bun.Subprocess` å¯¹è±¡ã€‚

```ts
const proc = Bun.spawn(["bun", "--version"]);
console.log(await proc.exited); // 0
```

`Bun.spawn` çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‚æ•°å¯¹è±¡ï¼Œç”¨æ¥é…ç½®å­è¿›ç¨‹ã€‚

```ts
const proc = Bun.spawn(["bun", "--version"], {
  cwd: "./path/to/subdir", // æŒ‡å®šå·¥ä½œç›®å½•
  env: { ...process.env, FOO: "bar" }, // æŒ‡å®šç¯å¢ƒå˜é‡
  onExit(proc, exitCode, signalCode, error) {
    // é€€å‡ºå¤„ç†å™¨
  },
});

proc.pid; // å­è¿›ç¨‹çš„è¿›ç¨‹ID
```

## è¾“å…¥æµ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå­è¿›ç¨‹çš„è¾“å…¥æµæ˜¯ `undefined`ï¼›å¯ä»¥é€šè¿‡ `stdin` å‚æ•°è¿›è¡Œé…ç½®ã€‚

```ts
const proc = Bun.spawn(["cat"], {
  stdin: await fetch("https://raw.githubusercontent.com/oven-sh/bun/main/examples/hashing.js"),
});

const text = await proc.stdout.text();
console.log(text); // "const input = "hello world".repeat(400); ..."
```

| å€¼                       | æè¿°                                                   |
| ------------------------ | ------------------------------------------------------ |
| `null`                   | **é»˜è®¤ã€‚** ä¸å‘å­è¿›ç¨‹æä¾›è¾“å…¥                          |
| `"pipe"`                 | è¿”å›ä¸€ä¸ª `FileSink` ç”¨äºå¿«é€Ÿå¢é‡å†™å…¥                   |
| `"inherit"`              | ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ `stdin`                                   |
| `Bun.file()`             | ä»æŒ‡å®šæ–‡ä»¶è¯»å–                                        |
| `TypedArray \| DataView` | ä½¿ç”¨äºŒè¿›åˆ¶ç¼“å†²åŒºä½œä¸ºè¾“å…¥                               |
| `Response`               | ä½¿ç”¨å“åº”ä½“ `body` ä½œä¸ºè¾“å…¥                             |
| `Request`                | ä½¿ç”¨è¯·æ±‚ä½“ `body` ä½œä¸ºè¾“å…¥                             |
| `ReadableStream`         | ä½¿ç”¨å¯è¯»æµä½œä¸ºè¾“å…¥                                     |
| `Blob`                   | ä½¿ç”¨ Blob ä½œä¸ºè¾“å…¥                                     |
| `number`                 | ä»ç»™å®šæ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶è¯»å–                             |

`"pipe"` é€‰é¡¹å…è®¸ä»çˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹çš„è¾“å…¥æµè¿›è¡Œå¢é‡å†™å…¥ã€‚

```ts
const proc = Bun.spawn(["cat"], {
  stdin: "pipe", // è¿”å›å¯å†™çš„ FileSink
});

// å…¥é˜Ÿå­—ç¬¦ä¸²æ•°æ®
proc.stdin.write("hello");

// å…¥é˜ŸäºŒè¿›åˆ¶æ•°æ®
const enc = new TextEncoder();
proc.stdin.write(enc.encode(" world!"));

// å‘é€ç¼“å†²æ•°æ®
proc.stdin.flush();

// å…³é—­è¾“å…¥æµ
proc.stdin.end();
```

å°†ä¸€ä¸ª `ReadableStream` ä¼ ç»™ `stdin`ï¼Œå¯ä»¥è®©ä½ ç›´æ¥ä» JavaScript çš„ `ReadableStream` å‘å­è¿›ç¨‹è¾“å…¥æµä¼ è¾“æ•°æ®ï¼š

```ts
const stream = new ReadableStream({
  start(controller) {
    controller.enqueue("Hello from ");
    controller.enqueue("ReadableStream!");
    controller.close();
  },
});

const proc = Bun.spawn(["cat"], {
  stdin: stream,
  stdout: "pipe",
});

const output = await proc.stdout.text();
console.log(output); // "Hello from ReadableStream!"
```

## è¾“å‡ºæµ

ä½ å¯ä»¥é€šè¿‡ `stdout` å’Œ `stderr` å±æ€§è¯»å–å­è¿›ç¨‹çš„è¾“å‡ºã€‚é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬æ˜¯ `ReadableStream` çš„å®ä¾‹ã€‚

```ts
const proc = Bun.spawn(["bun", "--version"]);
const text = await proc.stdout.text();
console.log(text); // => "1.3.3\n"
```

é€šè¿‡å‘ `stdout/stderr` ä¼ å…¥ä»¥ä¸‹å€¼ä¹‹ä¸€æ¥é…ç½®è¾“å‡ºæµï¼š

| å€¼           | æè¿°                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------ |
| `"pipe"`     | **`stdout` çš„é»˜è®¤å€¼ã€‚** å°†è¾“å‡ºå¯¼å…¥è¿”å›çš„ `Subprocess` å¯¹è±¡çš„ `ReadableStream`               |
| `"inherit"`  | **`stderr` çš„é»˜è®¤å€¼ã€‚** ç»§æ‰¿è‡ªçˆ¶è¿›ç¨‹                                                      |
| `"ignore"`   | ä¸¢å¼ƒè¾“å‡º                                                                                  |
| `Bun.file()` | å†™å…¥æŒ‡å®šæ–‡ä»¶                                                                              |
| `number`     | å†™å…¥æŒ‡å®šæ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶                                                                  |

## é€€å‡ºå¤„ç†

ä½¿ç”¨ `onExit` å›è°ƒç›‘å¬è¿›ç¨‹é€€å‡ºæˆ–è¢«æ€æ­»ã€‚

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"], {
  onExit(proc, exitCode, signalCode, error) {
    // é€€å‡ºå¤„ç†å™¨
  },
});
```

ä¸ºæ–¹ä¾¿èµ·è§ï¼Œ`exited` å±æ€§æ˜¯ä¸€ä¸ªåœ¨è¿›ç¨‹é€€å‡ºæ—¶è§£æçš„ `Promise`ã€‚

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);

await proc.exited; // è¿›ç¨‹é€€å‡ºæ—¶è§£æ
proc.killed; // å¸ƒå°”å€¼ â€” è¿›ç¨‹æ˜¯å¦è¢«æ€æ­»ï¼Ÿ
proc.exitCode; // null | æ•°å­—
proc.signalCode; // null | "SIGABRT" | "SIGALRM" | ...
```

æ€æ­»è¿›ç¨‹ï¼š

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);
proc.kill();
proc.killed; // true

proc.kill(15); // æŒ‡å®šä¿¡å·ç 
proc.kill("SIGTERM"); // æŒ‡å®šä¿¡å·å
```

çˆ¶è¿›ç¨‹ `bun` åœ¨æ‰€æœ‰å­è¿›ç¨‹é€€å‡ºå‰ä¸ä¼šç»ˆæ­¢ã€‚ä½¿ç”¨ `proc.unref()` å¯ä»¥å°†å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹åˆ†ç¦»ã€‚

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);
proc.unref();
```

## èµ„æºä½¿ç”¨

è¿›ç¨‹é€€å‡ºåï¼Œä½ å¯ä»¥è·å–è¯¥è¿›ç¨‹çš„èµ„æºä½¿ç”¨ä¿¡æ¯ï¼š

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);
await proc.exited;

const usage = proc.resourceUsage();
console.log(`æœ€å¤§å†…å­˜ä½¿ç”¨é‡: ${usage.maxRSS} å­—èŠ‚`);
console.log(`CPU æ—¶é—´ï¼ˆç”¨æˆ·æ€ï¼‰: ${usage.cpuTime.user} å¾®ç§’`);
console.log(`CPU æ—¶é—´ï¼ˆå†…æ ¸æ€ï¼‰: ${usage.cpuTime.system} å¾®ç§’`);
```

## ä½¿ç”¨ AbortSignal

ä½ å¯ä»¥ä½¿ç”¨ `AbortSignal` ä¸­æ­¢å­è¿›ç¨‹ï¼š

```ts index.ts icon="/icons/typescript.svg"
const controller = new AbortController();
const { signal } = controller;

const proc = Bun.spawn({
  cmd: ["sleep", "100"],
  signal,
});

// åç»­ä¸­æ­¢è¿›ç¨‹ï¼š
controller.abort();
```

## ä½¿ç”¨ timeout å’Œ killSignal

ä½ å¯ä»¥ä¸ºå­è¿›ç¨‹è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åè‡ªåŠ¨ç»ˆæ­¢è¿›ç¨‹ï¼š

```ts index.ts icon="/icons/typescript.svg"
// 5ç§’åæ€æ­»è¿›ç¨‹
const proc = Bun.spawn({
  cmd: ["sleep", "10"],
  timeout: 5000, // 5ç§’ï¼Œå•ä½æ¯«ç§’
});

await proc.exited; // 5ç§’åè§£æ
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¶…æ—¶è¿›ç¨‹ä¼šä½¿ç”¨ `SIGTERM` ä¿¡å·è¢«æ€æ­»ã€‚ä½ å¯ä»¥é€šè¿‡ `killSignal` é€‰é¡¹æŒ‡å®šä¸åŒä¿¡å·ï¼š

```ts index.ts icon="/icons/typescript.svg"
// 5ç§’åä½¿ç”¨ SIGKILL æ€æ­»è¿›ç¨‹
const proc = Bun.spawn({
  cmd: ["sleep", "10"],
  timeout: 5000,
  killSignal: "SIGKILL", // å¯ä¸ºä¿¡å·åç§°æˆ–ä¿¡å·ç¼–å·
});
```

`killSignal` é€‰é¡¹ä¹Ÿæ§åˆ¶åœ¨ `AbortSignal` è§¦å‘æ—¶å‘é€çš„ä¿¡å·ã€‚

## ä½¿ç”¨ maxBuffer

å¯¹äº spawnSyncï¼Œä½ å¯ä»¥é™åˆ¶è¾“å‡ºçš„æœ€å¤§å­—èŠ‚æ•°ï¼Œè¶…è¿‡åˆ™æ€æ­»è¿›ç¨‹ï¼š

```ts index.ts icon="/icons/typescript.svg"
// â€˜yesâ€™ è¿›ç¨‹è¾“å‡ºè¶…è¿‡100å­—èŠ‚åè¢«æ€æ­»
const result = Bun.spawnSync({
  cmd: ["yes"], // Windows ä¸‹ä½¿ç”¨ ["bun", "exec", "yes"]
  maxBuffer: 100,
});
// è¿›ç¨‹é€€å‡º
```

## è¿›ç¨‹é—´é€šä¿¡ (IPC)

Bun æ”¯æŒåœ¨ä¸¤ä¸ª `bun` è¿›ç¨‹é—´å»ºç«‹ç›´æ¥çš„è¿›ç¨‹é—´é€šä¿¡é€šé“ã€‚è¦ä»è¢«åˆ›å»ºçš„ Bun å­è¿›ç¨‹æ¥æ”¶æ¶ˆæ¯ï¼Œè¯·æŒ‡å®š `ipc` å¤„ç†å™¨ã€‚

```ts parent.ts icon="/icons/typescript.svg"
const child = Bun.spawn(["bun", "child.ts"], {
  ipc(message) {
    /**
     * ä»å­è¿›ç¨‹æ”¶åˆ°çš„æ¶ˆæ¯
     **/
  },
});
```

çˆ¶è¿›ç¨‹å¯é€šè¿‡è¿”å›çš„ `Subprocess` å¯¹è±¡ä¸Šçš„ `.send()` æ–¹æ³•å‘å­è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚å­è¿›ç¨‹åœ¨ `ipc` å¤„ç†å™¨ç¬¬äºŒä¸ªå‚æ•°ä¸­è·å¾—å‘é€è€…å¼•ç”¨ã€‚

```ts parent.ts icon="/icons/typescript.svg"
const childProc = Bun.spawn(["bun", "child.ts"], {
  ipc(message, childProc) {
    /**
     * ä»å­è¿›ç¨‹æ”¶åˆ°çš„æ¶ˆæ¯
     **/
    childProc.send("Respond to child");
  },
});

childProc.send("I am your father"); // çˆ¶è¿›ç¨‹ä¹Ÿå¯å‘å­è¿›ç¨‹å‘é€æ¶ˆæ¯
```

å­è¿›ç¨‹å¯ç”¨ `process.send()` å‘çˆ¶è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œç”¨ `process.on("message")` æ¥æ”¶æ¶ˆæ¯ã€‚è¿™ä¸ Node.js ä¸­ `child_process.fork()` ä½¿ç”¨çš„ API ç›¸åŒã€‚

```ts child.ts
process.send("Hello from child as string");
process.send({ message: "Hello from child as object" });

process.on("message", message => {
  // æ‰“å°æ¥è‡ªçˆ¶è¿›ç¨‹çš„æ¶ˆæ¯
  console.log(message);
});
```

```ts child.ts
// å‘é€å­—ç¬¦ä¸²æ¶ˆæ¯
process.send("Hello from child as string");

// å‘é€å¯¹è±¡æ¶ˆæ¯
process.send({ message: "Hello from child as object" });
```

`serialization` é€‰é¡¹æ§åˆ¶ä¸¤è¿›ç¨‹é—´é€šä¿¡çš„åºåˆ—åŒ–æ ¼å¼ï¼š

- `advanced`ï¼šï¼ˆé»˜è®¤ï¼‰æ¶ˆæ¯ä½¿ç”¨ JSC çš„ `serialize` API åºåˆ—åŒ–ï¼Œæ”¯æŒå…‹éš†[æ‰€æœ‰ `structuredClone` æ”¯æŒçš„ç±»å‹](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm) ï¼Œä½†ä¸æ”¯æŒå¯¹è±¡æ‰€æœ‰æƒè½¬ç§»ã€‚
- `json`ï¼šæ¶ˆæ¯ä½¿ç”¨ `JSON.stringify` å’Œ `JSON.parse` åºåˆ—åŒ–ï¼Œæ”¯æŒå¯¹è±¡ç±»å‹æ¯” `advanced` å°‘ã€‚

æ–­å¼€ä¸çˆ¶è¿›ç¨‹çš„ IPC é€šé“å¯è°ƒç”¨ï¼š

```ts
childProc.disconnect();
```

### Bun ä¸ Node.js ä¹‹é—´çš„ IPC

è¦åœ¨ `bun` å’Œ Node.js è¿›ç¨‹é—´ä½¿ç”¨ IPCï¼Œè¯·åœ¨ `Bun.spawn` è®¾ç½® `serialization: "json"`ã€‚è¿™æ˜¯å› ä¸º Node.js å’Œ Bun ä½¿ç”¨ä¸åŒçš„ JS å¼•æ“åŠä¸åŒçš„å¯¹è±¡åºåˆ—åŒ–æ ¼å¼ã€‚

```js bun-node-ipc.js icon="file-code"
if (typeof Bun !== "undefined") {
  const prefix = `[bun ${process.versions.bun} ğŸ‡]`;
  const node = Bun.spawn({
    cmd: ["node", __filename],
    ipc({ message }) {
      console.log(message);
      node.send({ message: `${prefix} ğŸ‘‹ hey node` });
      node.kill();
    },
    stdio: ["inherit", "inherit", "inherit"],
    serialization: "json",
  });

  node.send({ message: `${prefix} ğŸ‘‹ hey node` });
} else {
  const prefix = `[node ${process.version}]`;
  process.on("message", ({ message }) => {
    console.log(message);
    process.send({ message: `${prefix} ğŸ‘‹ hey bun` });
  });
}
```

---

## ç»ˆç«¯ï¼ˆPTYï¼‰æ”¯æŒ

å¯¹äºäº¤äº’å¼ç»ˆç«¯åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ `terminal` é€‰é¡¹ä¸ºå­è¿›ç¨‹é™„åŠ ä¼ªç»ˆç«¯ï¼ˆPTYï¼‰ã€‚è¿™è®©å­è¿›ç¨‹è®¤ä¸ºè‡ªå·±è¿è¡Œåœ¨çœŸå®ç»ˆç«¯ä¸­ï¼Œå¯ç”¨å½©è‰²è¾“å‡ºã€å…‰æ ‡ç§»åŠ¨å’Œäº¤äº’å¼æç¤ºç­‰åŠŸèƒ½ã€‚

```ts
const proc = Bun.spawn(["bash"], {
  terminal: {
    cols: 80,
    rows: 24,
    data(terminal, data) {
      // ç»ˆç«¯æ¥æ”¶æ•°æ®æ—¶è¢«è°ƒç”¨
      process.stdout.write(data);
    },
  },
});

// å‘ç»ˆç«¯å†™æ•°æ®
proc.terminal.write("echo hello\n");

// ç­‰å¾…è¿›ç¨‹é€€å‡º
await proc.exited;

// å…³é—­ç»ˆç«¯
proc.terminal.close();
```

æä¾› `terminal` é€‰é¡¹æ—¶ï¼š

- å­è¿›ç¨‹ä¸­ `process.stdout.isTTY` ä¸º `true`
- `stdin`ã€`stdout` å’Œ `stderr` éƒ½ç»‘å®šåˆ°ç»ˆç«¯
- `proc.stdin`ã€`proc.stdout` å’Œ `proc.stderr` è¿”å› `null` â€”â€” ä½¿ç”¨ç»ˆç«¯å¯¹è±¡ä»£æ›¿
- å¯é€šè¿‡ `proc.terminal` è®¿é—®ç»ˆç«¯

### ç»ˆç«¯é€‰é¡¹

| é€‰é¡¹     | æè¿°                                                                                                            | é»˜è®¤å€¼              |
| -------- | ---------------------------------------------------------------------------------------------------------------- | ------------------- |
| `cols`   | åˆ—æ•°                                                                                                            | `80`                |
| `rows`   | è¡Œæ•°                                                                                                            | `24`                |
| `name`   | PTY é…ç½®çš„ç»ˆç«¯ç±»å‹ï¼ˆé€šè¿‡ `env` é€‰é¡¹å•ç‹¬è®¾ç½® `TERM` ç¯å¢ƒå˜é‡ï¼‰                                                   | `"xterm-256color"`  |
| `data`   | æ¥æ”¶æ•°æ®æ—¶å›è°ƒ `(terminal, data) => void`                                                                      | â€”                   |
| `exit`   | PTY æµå…³é—­æ—¶å›è°ƒï¼ˆEOF æˆ–é”™è¯¯ï¼‰ã€‚`exitCode` æ˜¯ PTY ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆ0ä¸ºEOFï¼Œ1ä¸ºé”™è¯¯ï¼‰ï¼Œè€Œéå­è¿›ç¨‹é€€å‡ºç ã€‚ä½¿ç”¨ `proc.exited` ç›‘å¬è¿›ç¨‹é€€å‡ºã€‚ | â€”                   |
| `drain`  | å¯å†™æµå‡†å¤‡å¥½æ¥æ”¶æ›´å¤šæ•°æ®æ—¶å›è°ƒ `(terminal) => void`                                                             | â€”                   |

### ç»ˆç«¯æ–¹æ³•

`proc.terminal` è¿”å›çš„ `Terminal` å¯¹è±¡å…·æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š

```ts
// å‘ç»ˆç«¯å†™å…¥æ•°æ®
proc.terminal.write("echo hello\n");

// è°ƒæ•´ç»ˆç«¯å¤§å°
proc.terminal.resize(120, 40);

// è®¾ç½®åŸç”Ÿæ¨¡å¼ï¼ˆç¦ç”¨è¡Œç¼“å†²ä¸å›æ˜¾ï¼‰
proc.terminal.setRawMode(true);

// ä¿æŒäº‹ä»¶å¾ªç¯æ´»åŠ¨ç›´åˆ°ç»ˆç«¯å…³é—­
proc.terminal.ref();
proc.terminal.unref();

// å…³é—­ç»ˆç«¯
proc.terminal.close();
```

### å¯å¤ç”¨ç»ˆç«¯

ä½ å¯ä»¥ç‹¬ç«‹åˆ›å»ºä¸€ä¸ªç»ˆç«¯å¯¹è±¡å¹¶åœ¨å¤šä¸ªå­è¿›ç¨‹é—´é‡ç”¨ï¼š

```ts
await using terminal = new Bun.Terminal({
  cols: 80,
  rows: 24,
  data(term, data) {
    process.stdout.write(data);
  },
});

// åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹
const proc1 = Bun.spawn(["echo", "first"], { terminal });
await proc1.exited;

// å¤ç”¨ç»ˆç«¯å¯åŠ¨å¦ä¸€ä¸ªè¿›ç¨‹
const proc2 = Bun.spawn(["echo", "second"], { terminal });
await proc2.exited;

// ç»ˆç«¯ä¼šè¢« `await using` è‡ªåŠ¨å…³é—­
```

ä¼ å…¥å·²æœ‰çš„ `Terminal` å¯¹è±¡æ—¶ï¼š

- ç»ˆç«¯å¯è·¨å¤šä¸ªè¿›ç¨‹å¤ç”¨
- ä½ è´Ÿè´£ä½•æ—¶å…³é—­ç»ˆç«¯
- `exit` å›è°ƒåœ¨è°ƒç”¨ `terminal.close()` æ—¶è§¦å‘ï¼Œè€Œéæ¯ä¸ªå­è¿›ç¨‹é€€å‡ºæ—¶
- ä½¿ç”¨ `proc.exited` ä¾¦æµ‹æ¯ä¸ªå­è¿›ç¨‹é€€å‡º

è¿™é€‚åˆåœ¨åŒä¸€ç»ˆç«¯ä¼šè¯ä¸­é¡ºåºè¿è¡Œå¤šä¸ªå‘½ä»¤ã€‚

<Note>ç»ˆç«¯æ”¯æŒä»…é™ POSIX ç³»ç»Ÿï¼ˆLinuxã€macOSï¼‰ã€‚Windows ä¸æ”¯æŒæ­¤åŠŸèƒ½ã€‚</Note>

---

## é˜»å¡å¼ API (`Bun.spawnSync()`)

Bun æä¾›äº† `Bun.spawn` çš„åŒæ­¥ç‰ˆæœ¬ `Bun.spawnSync`ã€‚è¿™æ˜¯ä¸€ä¸ªé˜»å¡ APIï¼Œæ”¯æŒä¸ `Bun.spawn` ç›¸åŒçš„è¾“å…¥å’Œå‚æ•°ã€‚å®ƒè¿”å›ä¸€ä¸ª `SyncSubprocess` å¯¹è±¡ï¼Œä¸ `Subprocess` æœ‰å‡ ç‚¹ä¸åŒï¼š

1. å«æœ‰è¡¨ç¤ºè¿›ç¨‹æ˜¯å¦ä»¥é›¶é€€å‡ºç é€€å‡ºçš„ `success` å±æ€§ã€‚
2. `stdout` å’Œ `stderr` æ˜¯ `Buffer` å®ä¾‹ï¼Œè€Œé `ReadableStream`ã€‚
3. æ²¡æœ‰ `stdin` å±æ€§ã€‚è‹¥éœ€å¢é‡å†™å…¥è¾“å…¥æµï¼Œè¯·ä½¿ç”¨ `Bun.spawn`ã€‚

```ts
const proc = Bun.spawnSync(["echo", "hello"]);

console.log(proc.stdout.toString());
// => "hello\n"
```

åŸåˆ™ä¸Šï¼Œå¼‚æ­¥çš„ `Bun.spawn` é€‚åˆ HTTP æœåŠ¡å™¨å’Œåº”ç”¨ï¼Œ`Bun.spawnSync` æ›´é€‚åˆæ„å»ºå‘½ä»¤è¡Œå·¥å…·ã€‚

---

## æ€§èƒ½åŸºå‡†

<Note>
  âš¡ï¸ åº•å±‚ï¼Œ`Bun.spawn` å’Œ `Bun.spawnSync` ä½¿ç”¨
  [`posix_spawn(3)`](https://man7.org/linux/man-pages/man3/posix_spawn.3.html) ç³»ç»Ÿè°ƒç”¨ã€‚
</Note>

Bun çš„ `spawnSync` æ¯” Node.js çš„ `child_process` æ¨¡å—å¿« 60%ã€‚

```bash terminal icon="terminal"
bun spawn.mjs
```

```txt
cpu: Apple M1 Max
runtime: bun 1.x (arm64-darwin)

benchmark              time (avg)             (min â€¦ max)       p75       p99      p995
--------------------------------------------------------- -----------------------------
spawnSync echo hi  888.14 Âµs/iter    (821.83 Âµs â€¦ 1.2 ms) 905.92 Âµs      1 ms   1.03 ms
```

```sh terminal icon="terminal"
node spawn.node.mjs
```

```txt
cpu: Apple M1 Max
runtime: node v18.9.1 (arm64-darwin)

benchmark              time (avg)             (min â€¦ max)       p75       p99      p995
--------------------------------------------------------- -----------------------------
spawnSync echo hi    1.47 ms/iter     (1.14 ms â€¦ 2.64 ms)   1.57 ms   2.37 ms   2.52 ms
```

---

## å‚è€ƒ

ä¸‹é¢æ˜¯ Spawn API åŠç±»å‹çš„å‚è€ƒã€‚çœŸå®çš„ç±»å‹ä¸­åŒ…å«å¤æ‚æ³›å‹ä»¥æ ¹æ® `Bun.spawn` å’Œ `Bun.spawnSync` ä¼ å…¥çš„é€‰é¡¹ä¸¥å¯†ç±»å‹åŒ– `Subprocess` æµã€‚å®Œæ•´ç»†èŠ‚å‚è§ [bun.d.ts](https://github.com/oven-sh/bun/blob/main/packages/bun-types/bun.d.ts) ä¸­çš„å®šä¹‰ã€‚

```ts See Typescript Definitions expandable
interface Bun {
  spawn(command: string[], options?: SpawnOptions.OptionsObject): Subprocess;
  spawnSync(command: string[], options?: SpawnOptions.OptionsObject): SyncSubprocess;

  spawn(options: { cmd: string[] } & SpawnOptions.OptionsObject): Subprocess;
  spawnSync(options: { cmd: string[] } & SpawnOptions.OptionsObject): SyncSubprocess;
}

namespace SpawnOptions {
  interface OptionsObject {
    cwd?: string;
    env?: Record<string, string | undefined>;
    stdio?: [Writable, Readable, Readable];
    stdin?: Writable;
    stdout?: Readable;
    stderr?: Readable;
    onExit?(
      subprocess: Subprocess,
      exitCode: number | null,
      signalCode: number | null,
      error?: ErrorLike,
    ): void | Promise<void>;
    ipc?(message: any, subprocess: Subprocess): void;
    serialization?: "json" | "advanced";
    windowsHide?: boolean;
    windowsVerbatimArguments?: boolean;
    argv0?: string;
    signal?: AbortSignal;
    timeout?: number;
    killSignal?: string | number;
    maxBuffer?: number;
    terminal?: TerminalOptions; // ä»…é™ POSIX çš„ PTY æ”¯æŒ
  }

  type Readable =
    | "pipe"
    | "inherit"
    | "ignore"
    | null // ç­‰ä»·äº "ignore"
    | undefined // ä½¿ç”¨é»˜è®¤å€¼
    | BunFile
    | ArrayBufferView
    | number;

  type Writable =
    | "pipe"
    | "inherit"
    | "ignore"
    | null // ç­‰ä»·äº "ignore"
    | undefined // ä½¿ç”¨é»˜è®¤å€¼
    | BunFile
    | ArrayBufferView
    | number
    | ReadableStream
    | Blob
    | Response
    | Request;
}

interface Subprocess extends AsyncDisposable {
  readonly stdin: FileSink | number | undefined | null;
  readonly stdout: ReadableStream<Uint8Array<ArrayBuffer>> | number | undefined | null;
  readonly stderr: ReadableStream<Uint8Array<ArrayBuffer>> | number | undefined | null;
  readonly readable: ReadableStream<Uint8Array<ArrayBuffer>> | number | undefined | null;
  readonly terminal: Terminal | undefined;
  readonly pid: number;
  readonly exited: Promise<number>;
  readonly exitCode: number | null;
  readonly signalCode: NodeJS.Signals | null;
  readonly killed: boolean;

  kill(exitCode?: number | NodeJS.Signals): void;
  ref(): void;
  unref(): void;

  send(message: any): void;
  disconnect(): void;
  resourceUsage(): ResourceUsage | undefined;
}

interface SyncSubprocess {
  stdout: Buffer | undefined;
  stderr: Buffer | undefined;
  exitCode: number;
  success: boolean;
  resourceUsage: ResourceUsage;
  signalCode?: string;
  exitedDueToTimeout?: true;
  pid: number;
}

interface TerminalOptions {
  cols?: number;
  rows?: number;
  name?: string;
  data?: (terminal: Terminal, data: Uint8Array<ArrayBuffer>) => void;
  /** PTY æµå…³é—­æ—¶è°ƒç”¨ï¼ˆEOF æˆ–é”™è¯¯ï¼‰ã€‚exitCode æ˜¯ PTY ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆ0=EOFï¼Œ1=é”™è¯¯ï¼‰ï¼Œéå­è¿›ç¨‹é€€å‡ºç ã€‚ */
  exit?: (terminal: Terminal, exitCode: number, signal: string | null) => void;
  drain?: (terminal: Terminal) => void;
}

interface Terminal extends AsyncDisposable {
  readonly stdin: number;
  readonly stdout: number;
  readonly closed: boolean;
  write(data: string | BufferSource): number;
  resize(cols: number, rows: number): void;
  setRawMode(enabled: boolean): void;
  ref(): void;
  unref(): void;
  close(): void;
}

interface ResourceUsage {
  contextSwitches: {
    voluntary: number;
    involuntary: number;
  };

  cpuTime: {
    user: number;
    system: number;
    total: number;
  };
  maxRSS: number;

  messages: {
    sent: number;
    received: number;
  };
  ops: {
    in: number;
    out: number;
  };
  shmSize: number;
  signalCount: number;
  swapCount: number;
}

type Signal =
  | "SIGABRT"
  | "SIGALRM"
  | "SIGBUS"
  | "SIGCHLD"
  | "SIGCONT"
  | "SIGFPE"
  | "SIGHUP"
  | "SIGILL"
  | "SIGINT"
  | "SIGIO"
  | "SIGIOT"
  | "SIGKILL"
  | "SIGPIPE"
  | "SIGPOLL"
  | "SIGPROF"
  | "SIGPWR"
  | "SIGQUIT"
  | "SIGSEGV"
  | "SIGSTKFLT"
  | "SIGSTOP"
  | "SIGSYS"
  | "SIGTERM"
  | "SIGTRAP"
  | "SIGTSTP"
  | "SIGTTIN"
  | "SIGTTOU"
  | "SIGUNUSED"
  | "SIGURG"
  | "SIGUSR1"
  | "SIGUSR2"
  | "SIGVTALRM"
  | "SIGWINCH"
  | "SIGXCPU"
  | "SIGXFSZ"
  | "SIGBREAK"
  | "SIGLOST"
  | "SIGINFO";
```
